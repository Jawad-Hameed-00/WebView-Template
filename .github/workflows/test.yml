name: Android App Builder (Signed APK)

on:
  workflow_dispatch:
    inputs:
      build_url:
        description: 'URL to build.json'
        required: true
        default: 'https://savist.online/build.json'

env:
  BUILD_CONFIG_URL: ${{ github.event.inputs.build_url }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # Checkout repository
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: master

    # --------------------------------------------------
    # Set up JDK
    # --------------------------------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # --------------------------------------------------
    # Download build configuration
    # --------------------------------------------------
    - name: Download build configuration
      run: |
        echo "Downloading build config from: $BUILD_CONFIG_URL"
        curl -s -o build_config.json "$BUILD_CONFIG_URL"
        echo "Build config:"
        cat build_config.json

    # --------------------------------------------------
    # Parse JSON configuration
    # --------------------------------------------------
    - name: Parse build configuration
      id: config
      run: |
        echo "Extracting build parameters..."
        
        WEBSITE_URL=$(jq -r '.website_url' build_config.json)
        APP_NAME=$(jq -r '.app_name' build_config.json)
        PACKAGE_NAME=$(jq -r '.package_name' build_config.json)
        LOGO_URL=$(jq -r '.logo_url' build_config.json)
        USER_ID=$(jq -r '.user_id' build_config.json)
        
        echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_OUTPUT
        echo "LOGO_URL=$LOGO_URL" >> $GITHUB_OUTPUT
        echo "USER_ID=$USER_ID" >> $GITHUB_OUTPUT
        
        echo "App Name: $APP_NAME"
        echo "Package: $PACKAGE_NAME"
        echo "Website: $WEBSITE_URL"

    # --------------------------------------------------
    # Find original package name
    # --------------------------------------------------
    - name: Find original package name
      id: find_package
      run: |
        echo "Finding original package name..."
        
        # Try AndroidManifest.xml first
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          ORIGINAL_PACKAGE=$(grep -o 'package="[^"]*"' app/src/main/AndroidManifest.xml | head -1 | sed 's/package="//' | sed 's/"//')
          echo "Found in AndroidManifest.xml: $ORIGINAL_PACKAGE"
        elif [ -f "app/build.gradle" ]; then
          # Try build.gradle
          ORIGINAL_PACKAGE=$(grep -o "namespace ['\"][^'\"]*['\"]" app/build.gradle | head -1 | sed "s/namespace ['\"]//" | sed "s/['\"]//" || 
                            grep -o 'applicationId "[^"]*"' app/build.gradle | head -1 | sed 's/applicationId "//' | sed 's/"//')
          echo "Found in build.gradle: $ORIGINAL_PACKAGE"
        else
          # Find from Java/Kotlin files
          JAVA_FILE=$(find app/src/main/java -name "*.java" -o -name "*.kt" 2>/dev/null | head -1)
          if [ -f "$JAVA_FILE" ]; then
            ORIGINAL_PACKAGE=$(grep -o 'package [^;]*' "$JAVA_FILE" | head -1 | sed 's/package //')
            echo "Found in Java file: $ORIGINAL_PACKAGE"
          else
            ORIGINAL_PACKAGE="com.yourapp.app"
            echo "Using default: $ORIGINAL_PACKAGE"
          fi
        fi
        
        echo "ORIGINAL_PACKAGE=$ORIGINAL_PACKAGE" >> $GITHUB_OUTPUT
        echo "NEW_PACKAGE=${{ steps.config.outputs.PACKAGE_NAME }}" >> $GITHUB_OUTPUT

    # --------------------------------------------------
    # Setup Android SDK
    # --------------------------------------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # --------------------------------------------------
    # Create keystore
    # --------------------------------------------------
    - name: Create release keystore
      run: |
        echo "Creating keystore..."
        keytool -genkeypair \
          -keystore release.jks \
          -alias release \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android123 \
          -keypass android123 \
          -dname "CN=AppBuilder, OU=Mobile, O=Savist, L=Bahawalpur, S=Punjab, C=PK"
        echo "Keystore created"

    # --------------------------------------------------
    # Configure signing
    # --------------------------------------------------
    - name: Configure signing
      run: |
        echo "Configuring signing..."
        
        # Add to gradle.properties
        echo "" >> gradle.properties
        echo "# Auto-generated signing config" >> gradle.properties
        echo "RELEASE_STORE_FILE=$(pwd)/release.jks" >> gradle.properties
        echo "RELEASE_STORE_PASSWORD=android123" >> gradle.properties
        echo "RELEASE_KEY_ALIAS=release" >> gradle.properties
        echo "RELEASE_KEY_PASSWORD=android123" >> gradle.properties

    # --------------------------------------------------
    # Download and update app logo
    # --------------------------------------------------
    - name: Download and update app logo
      run: |
        echo "Downloading logo from: ${{ steps.config.outputs.LOGO_URL }}"
        
        # Install imagemagick for image processing
        sudo apt-get update
        sudo apt-get install -y imagemagick
        
        # Download logo
        wget -O downloaded_logo.png "${{ steps.config.outputs.LOGO_URL }}"
        
        # Update existing launcher icons
        find app/src/main/res -name "ic_launcher*.png" -o -name "ic_launcher*.jpg" -o -name "ic_launcher*.jpeg" -o -name "ic_launcher*.webp" 2>/dev/null | while read icon; do
          echo "Updating: $icon"
          dir=$(dirname "$icon")
          
          # Resize based on directory
          case "$dir" in
            *mipmap-hdpi*)
              convert downloaded_logo.png -resize 72x72 "$icon"
              ;;
            *mipmap-mdpi*)
              convert downloaded_logo.png -resize 48x48 "$icon"
              ;;
            *mipmap-xhdpi*)
              convert downloaded_logo.png -resize 96x96 "$icon"
              ;;
            *mipmap-xxhdpi*)
              convert downloaded_logo.png -resize 144x144 "$icon"
              ;;
            *mipmap-xxxhdpi*)
              convert downloaded_logo.png -resize 192x192 "$icon"
              ;;
            *)
              # Default size
              convert downloaded_logo.png -resize 512x512 "$icon"
              ;;
          esac
        done

    # --------------------------------------------------
    # FIRST: Create strings.xml BEFORE package rename
    # --------------------------------------------------
    - name: Create strings.xml (First Step)
      run: |
        echo "=== CREATING STRINGS.XML ==="
        
        # Create directory
        mkdir -p app/src/main/res/values
        
        # Use a VERY safe approach - write line by line
        {
          echo '<?xml version="1.0" encoding="utf-8"?>'
          echo '<resources>'
          echo "    <string name=\"app_name\">${{ steps.config.outputs.APP_NAME }}</string>"
          echo "    <string name=\"website_url\">${{ steps.config.outputs.WEBSITE_URL }}</string>"
          echo '</resources>'
        } > app/src/main/res/values/strings.xml
        
        echo "Created strings.xml with:"
        echo "App Name: ${{ steps.config.outputs.APP_NAME }}"
        echo "Website: ${{ steps.config.outputs.WEBSITE_URL }}"
        
        echo "File content:"
        cat app/src/main/res/values/strings.xml
        echo "=== END STRINGS.XML ==="

    # --------------------------------------------------
    # COMPLETE PACKAGE RENAME - EXCLUDING strings.xml
    # --------------------------------------------------
    - name: Complete Package Rename
      run: |
        echo "=== PACKAGE RENAME PROCESS ==="
        OLD_PACKAGE="${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}"
        NEW_PACKAGE="${{ steps.config.outputs.PACKAGE_NAME }}"
        
        echo "From: $OLD_PACKAGE"
        echo "To: $NEW_PACKAGE"
        
        # Convert package names to directory paths
        OLD_PATH=$(echo "$OLD_PACKAGE" | tr '.' '/')
        NEW_PATH=$(echo "$NEW_PACKAGE" | tr '.' '/')
        
        echo "Old path: $OLD_PATH"
        echo "New path: $NEW_PATH"
        
        # Step 1: Update AndroidManifest.xml (EXCLUDE strings.xml from search)
        echo "1. Updating AndroidManifest.xml..."
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          # Update package attribute ONLY
          sed -i "s|package=\"$OLD_PACKAGE\"|package=\"$NEW_PACKAGE\"|g" app/src/main/AndroidManifest.xml
          # Update activity references
          sed -i "s|android:name=\"\\.|android:name=\"$NEW_PACKAGE\\.|g" app/src/main/AndroidManifest.xml
          sed -i "s|android:name=\"$OLD_PACKAGE\\.|android:name=\"$NEW_PACKAGE\\.|g" app/src/main/AndroidManifest.xml
          echo "‚úì AndroidManifest.xml updated"
        fi
        
        # Step 2: Update ALL build.gradle files
        echo "2. Updating build.gradle files..."
        find . -name "*.gradle" -o -name "*.gradle.kts" | while read gradle_file; do
          echo "  Updating: $gradle_file"
          # Update namespace - be very specific
          sed -i "s|\"$OLD_PACKAGE\"|\"$NEW_PACKAGE\"|g" "$gradle_file"
          sed -i "s|'$OLD_PACKAGE'|'$NEW_PACKAGE'|g" "$gradle_file"
          # Update applicationId - be very specific
          sed -i "s|applicationId \"$OLD_PACKAGE\"|applicationId \"$NEW_PACKAGE\"|gI" "$gradle_file"
          sed -i "s|applicationId '$OLD_PACKAGE'|applicationId '$NEW_PACKAGE'|gI" "$gradle_file"
        done
        echo "‚úì Gradle files updated"
        
        # Step 3: Update Java source files (EXCLUDE res directory)
        echo "3. Updating Java source files..."
        if [ -d "app/src/main/java" ]; then
          # Find and update all Java files
          find app/src/main/java -type f -name "*.java" | while read java_file; do
            echo "  Updating: $java_file"
            # Update package declaration - match exact line
            sed -i "s|^package $OLD_PACKAGE;|package $NEW_PACKAGE;|g" "$java_file"
            # Update imports - be specific
            sed -i "s|import $OLD_PACKAGE\\.|import $NEW_PACKAGE\\.|g" "$java_file"
            # Update R imports
            sed -i "s|import $OLD_PACKAGE\\.R;|import $NEW_PACKAGE\\.R;|g" "$java_file"
            sed -i "s|import $OLD_PACKAGE\\.databinding\\.|import $NEW_PACKAGE\\.databinding\\.|g" "$java_file"
          done
          echo "‚úì Java files updated"
        fi
        
        # Step 4: Update Kotlin source files (EXCLUDE res directory)
        echo "4. Updating Kotlin source files..."
        if [ -d "app/src/main/kotlin" ]; then
          find app/src/main/kotlin -type f -name "*.kt" | while read kt_file; do
            echo "  Updating: $kt_file"
            sed -i "s|^package $OLD_PACKAGE$|package $NEW_PACKAGE|g" "$kt_file"
            sed -i "s|import $OLD_PACKAGE\\.|import $NEW_PACKAGE\\.|g" "$kt_file"
          done
          echo "‚úì Kotlin files updated"
        fi
        
        # Step 5: Update XML layout files ONLY (EXCLUDE strings.xml)
        echo "5. Updating XML layout files..."
        find app/src -type f -name "*.xml" | grep -v "strings.xml" | while read xml_file; do
          # Skip build directories and resource value files
          if [[ "$xml_file" != *"/build/"* ]] && [[ "$xml_file" != *"/values/"* ]]; then
            echo "  Updating: $xml_file"
            # Update custom view references - be very careful
            sed -i "s|$OLD_PACKAGE\\.|$NEW_PACKAGE\\.|g" "$xml_file"
          fi
        done
        echo "‚úì XML layout files updated"
        
        # Step 6: MOVE SOURCE FILES to new directory structure
        echo "6. Moving source files to new package structure..."
        
        # Move Java files
        if [ -d "app/src/main/java/$OLD_PATH" ] && [ "$OLD_PACKAGE" != "$NEW_PACKAGE" ]; then
          echo "  Moving Java from: app/src/main/java/$OLD_PATH"
          echo "  Moving Java to: app/src/main/java/$NEW_PATH"
          
          # Create new directory
          mkdir -p "app/src/main/java/$NEW_PATH"
          
          # Copy all files from old to new
          if [ -d "app/src/main/java/$OLD_PATH" ]; then
            cp -r "app/src/main/java/$OLD_PATH/"* "app/src/main/java/$NEW_PATH/" 2>/dev/null || true
            
            # Remove old directory
            rm -rf "app/src/main/java/$OLD_PATH" 2>/dev/null || true
          fi
        fi
        
        # Move Kotlin files
        if [ -d "app/src/main/kotlin/$OLD_PATH" ] && [ "$OLD_PACKAGE" != "$NEW_PACKAGE" ]; then
          echo "  Moving Kotlin from: app/src/main/kotlin/$OLD_PATH"
          echo "  Moving Kotlin to: app/src/main/kotlin/$NEW_PATH"
          
          mkdir -p "app/src/main/kotlin/$NEW_PATH"
          
          if [ -d "app/src/main/kotlin/$OLD_PATH" ]; then
            cp -r "app/src/main/kotlin/$OLD_PATH/"* "app/src/main/kotlin/$NEW_PATH/" 2>/dev/null || true
            rm -rf "app/src/main/kotlin/$OLD_PATH" 2>/dev/null || true
          fi
        fi
        
        echo "‚úì Source files moved"
        
        # Step 7: Update settings.gradle (root project name)
        echo "7. Updating settings.gradle..."
        if [ -f "settings.gradle" ] || [ -f "settings.gradle.kts" ]; then
          # Update rootProject.name to use app name (simplified)
          APP_NAME_SAFE=$(echo "${{ steps.config.outputs.APP_NAME }}" | sed 's/[^a-zA-Z0-9]//g')
          if [ -n "$APP_NAME_SAFE" ]; then
            sed -i "s|rootProject.name =.*|rootProject.name = \"$APP_NAME_SAFE\"|g" settings.gradle* 2>/dev/null || true
          fi
          echo "‚úì settings.gradle updated"
        fi
        
        echo "=== PACKAGE RENAME COMPLETE ==="

    # --------------------------------------------------
    # PROTECT strings.xml - Make it read-only temporarily
    # --------------------------------------------------
    - name: Protect strings.xml
      run: |
        echo "Protecting strings.xml..."
        if [ -f "app/src/main/res/values/strings.xml" ]; then
          # Make it read-only temporarily
          chmod 444 app/src/main/res/values/strings.xml
          echo "‚úì strings.xml protected (read-only)"
          
          # Verify it wasn't corrupted
          echo "Verifying strings.xml content:"
          head -5 app/src/main/res/values/strings.xml
          echo "First line should be: <?xml version=\"1.0\" encoding=\"utf-8\"?>"
          
          FIRST_LINE=$(head -1 app/src/main/res/values/strings.xml)
          if [[ "$FIRST_LINE" != '<?xml version="1.0" encoding="utf-8"?>' ]]; then
            echo "‚ö† WARNING: strings.xml first line is: $FIRST_LINE"
            echo "Recreating strings.xml..."
            chmod 644 app/src/main/res/values/strings.xml
            {
              echo '<?xml version="1.0" encoding="utf-8"?>'
              echo '<resources>'
              echo "    <string name=\"app_name\">${{ steps.config.outputs.APP_NAME }}</string>"
              echo "    <string name=\"website_url\">${{ steps.config.outputs.WEBSITE_URL }}</string>"
              echo '</resources>'
            } > app/src/main/res/values/strings.xml
          fi
        fi

    # --------------------------------------------------
    # Clean up backup files
    # --------------------------------------------------
    - name: Clean backup files
      run: |
        echo "Cleaning up backup files..."
        find . -type f \( -name "*.backup" -o -name "*.bak" -o -name "*.back" -o -name "*~" \) -delete 2>/dev/null || true

    # --------------------------------------------------
    # Debug: Show what we've changed
    # --------------------------------------------------
    - name: Debug changes
      run: |
        echo "=== DEBUG: Checking critical files ==="
        echo ""
        echo "1. strings.xml (MUST BE CORRECT):"
        echo "---------------------------------"
        cat app/src/main/res/values/strings.xml
        echo "---------------------------------"
        echo ""
        echo "2. AndroidManifest.xml package:"
        echo "---------------------------------"
        grep 'package=' app/src/main/AndroidManifest.xml 2>/dev/null || echo "Not found"
        echo ""
        echo "3. app/build.gradle applicationId:"
        echo "---------------------------------"
        grep -i 'applicationId' app/build.gradle 2>/dev/null || echo "Not found"
        echo ""
        echo "4. Directory structure:"
        echo "---------------------------------"
        find app/src/main/java -type f -name "*.java" -o -name "*.kt" 2>/dev/null | head -10 || echo "No source files found"

    # --------------------------------------------------
    # Restore strings.xml permissions
    # --------------------------------------------------
    - name: Restore strings.xml permissions
      run: |
        echo "Restoring strings.xml permissions..."
        if [ -f "app/src/main/res/values/strings.xml" ]; then
          chmod 644 app/src/main/res/values/strings.xml
          echo "‚úì Permissions restored"
        fi

    # --------------------------------------------------
    # Clean and build
    # --------------------------------------------------
    - name: Clean and Build APK
      run: |
        echo "=== CLEANING AND BUILDING APK ==="
        
        # Clean
        echo "Cleaning..."
        rm -rf app/build .gradle build 2>/dev/null || true
        
        # Make gradlew executable
        if [ -f "gradlew" ]; then
          chmod +x gradlew
        else
          echo "Initializing gradle wrapper..."
          gradle wrapper --gradle-version 8.0
          chmod +x gradlew
        fi
        
        # Build with debug info
        echo "Building release APK..."
        ./gradlew clean assembleRelease --stacktrace
        
        echo "=== BUILD COMPLETED ==="
        
        # Show APK files
        echo "Generated APK files:"
        find . -name "*.apk" -type f | while read file; do
          echo "  - $file ($(ls -lh "$file" | awk '{print $5}'))"
        done

    # --------------------------------------------------
    # Verify APK package name
    # --------------------------------------------------
    - name: Verify APK
      run: |
        echo "=== VERIFYING APK ==="
        
        APK_FILE=$(find app/build/outputs/apk -name "*release*.apk" -type f | head -1)
        
        if [ -f "$APK_FILE" ]; then
          echo "‚úì APK found: $APK_FILE"
          echo "  Size: $(ls -lh "$APK_FILE" | awk '{print $5}')"
          
          # Try to get package info
          if command -v aapt &> /dev/null || command -v aapt2 &> /dev/null; then
            echo ""
            echo "APK Package Info:"
            echo "-----------------"
            # Try aapt first, then aapt2
            if command -v aapt &> /dev/null; then
              aapt dump badging "$APK_FILE" | grep -E "(package|application-label)" || true
            elif command -v aapt2 &> /dev/null; then
              aapt2 dump badging "$APK_FILE" | grep -E "(package|application-label)" || true
            fi
            echo "-----------------"
          else
            echo "Note: aapt not available for detailed verification"
          fi
        else
          echo "‚úó ERROR: No APK file found!"
          echo "Searching for APK files..."
          find . -type f -name "*.apk" 2>/dev/null || true
          exit 1
        fi
        echo "=== VERIFICATION COMPLETE ==="

    # --------------------------------------------------
    # Upload APK
    # --------------------------------------------------
    - name: Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.config.outputs.APP_NAME }}-${{ steps.config.outputs.USER_ID }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 7

    # --------------------------------------------------
    # Completion
    # --------------------------------------------------
    - name: Notify completion
      run: |
        echo "‚úÖ Build completed successfully!"
        echo "üì± App Name: ${{ steps.config.outputs.APP_NAME }}"
        echo "üì¶ Package: ${{ steps.config.outputs.PACKAGE_NAME }}"
        echo "üåê Website: ${{ steps.config.outputs.WEBSITE_URL }}"
        echo "üë§ User ID: ${{ steps.config.outputs.USER_ID }}"
