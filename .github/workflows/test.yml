name: Android App Builder (Signed APK)

on:
  workflow_dispatch:
    inputs:
      build_url:
        description: 'URL to build.json'
        required: true
        default: 'https://savist.online/build.json'

env:
  BUILD_CONFIG_URL: ${{ github.event.inputs.build_url }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # Checkout repository
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: master

    # --------------------------------------------------
    # Set up JDK
    # --------------------------------------------------
    - name: Set up JDLE 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # --------------------------------------------------
    # Download build configuration
    # --------------------------------------------------
    - name: Download build configuration
      run: |
        echo "Downloading build config from: $BUILD_CONFIG_URL"
        curl -s -o build_config.json "$BUILD_CONFIG_URL"
        echo "Build config:"
        cat build_config.json

    # --------------------------------------------------
    # Parse JSON configuration
    # --------------------------------------------------
    - name: Parse build configuration
      id: config
      run: |
        echo "Extracting build parameters..."
        
        WEBSITE_URL=$(jq -r '.website_url' build_config.json)
        APP_NAME=$(jq -r '.app_name' build_config.json)
        PACKAGE_NAME=$(jq -r '.package_name' build_config.json)
        LOGO_URL=$(jq -r '.logo_url' build_config.json)
        USER_ID=$(jq -r '.user_id' build_config.json)
        
        echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_OUTPUT
        echo "LOGO_URL=$LOGO_URL" >> $GITHUB_OUTPUT
        echo "USER_ID=$USER_ID" >> $GITHUB_OUTPUT
        
        echo "App Name: $APP_NAME"
        echo "Package: $PACKAGE_NAME"
        echo "Website: $WEBSITE_URL"

    # --------------------------------------------------
    # Find original package from MainActivity.kt
    # --------------------------------------------------
    - name: Find original package from MainActivity
      id: find_package
      run: |
        echo "Finding original package from MainActivity.kt..."
        
        # Find MainActivity.kt file
        MAIN_ACTIVITY=$(find app/src/main -name "MainActivity.kt" | head -1)
        
        if [ -f "$MAIN_ACTIVITY" ]; then
          # Extract package from the first line with "package"
          ORIGINAL_PACKAGE=$(grep -o '^package [^;]*' "$MAIN_ACTIVITY" | sed 's/package //')
          echo "Found in MainActivity.kt: $ORIGINAL_PACKAGE"
        else
          # Try Java MainActivity
          MAIN_ACTIVITY_JAVA=$(find app/src/main -name "MainActivity.java" | head -1)
          if [ -f "$MAIN_ACTIVITY_JAVA" ]; then
            ORIGINAL_PACKAGE=$(grep -o '^package [^;]*' "$MAIN_ACTIVITY_JAVA" | sed 's/package //')
            echo "Found in MainActivity.java: $ORIGINAL_PACKAGE"
          else
            ORIGINAL_PACKAGE="com.jawadhameed.webviewtemplate"
            echo "Using default: $ORIGINAL_PACKAGE"
          fi
        fi
        
        echo "ORIGINAL_PACKAGE=$ORIGINAL_PACKAGE" >> $GITHUB_OUTPUT
        echo "NEW_PACKAGE=${{ steps.config.outputs.PACKAGE_NAME }}" >> $GITHUB_OUTPUT

    # --------------------------------------------------
    # Setup Android SDK
    # --------------------------------------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # --------------------------------------------------
    # Create keystore
    # --------------------------------------------------
    - name: Create release keystore
      run: |
        echo "Creating keystore..."
        keytool -genkeypair \
          -keystore release.jks \
          -alias release \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android123 \
          -keypass android123 \
          -dname "CN=AppBuilder, OU=Mobile, O=Savist, L=Bahawalpur, S=Punjab, C=PK"
        echo "Keystore created"

    # --------------------------------------------------
    # Configure signing
    # --------------------------------------------------
    - name: Configure signing
      run: |
        echo "Configuring signing..."
        echo "" >> gradle.properties
        echo "# Auto-generated signing config" >> gradle.properties
        echo "RELEASE_STORE_FILE=$(pwd)/release.jks" >> gradle.properties
        echo "RELEASE_STORE_PASSWORD=android123" >> gradle.properties
        echo "RELEASE_KEY_ALIAS=release" >> gradle.properties
        echo "RELEASE_KEY_PASSWORD=android123" >> gradle.properties

    # --------------------------------------------------
    # COMPLETE LOGO PROCESSING FOR ANDROID
    # --------------------------------------------------
    - name: Process App Logo for All Densities
      run: |
        echo "=== PROCESSING APP LOGO FOR ALL DENSITIES ==="
        
        # Install required tools
        echo "Installing required tools..."
        sudo apt-get update
        sudo apt-get install -y imagemagick webp
        
        # Download logo
        echo "Downloading logo from: ${{ steps.config.outputs.LOGO_URL }}"
        wget -O original_logo.png "${{ steps.config.outputs.LOGO_URL }}"
        
        # Verify logo is 512x512
        echo "Verifying logo dimensions..."
        dimensions=$(identify -format "%wx%h" original_logo.png)
        if [ "$dimensions" != "512x512" ]; then
          echo "Resizing logo to 512x512..."
          convert original_logo.png -resize 512x512! resized_logo.png
          mv resized_logo.png original_logo.png
        fi
        
        # Create temporary directory for new icons
        TEMP_DIR="/tmp/android_icons"
        rm -rf "$TEMP_DIR"
        mkdir -p "$TEMP_DIR"
        
        # Define sizes for each density (in dp, converted to pixels for xxxhdpi)
        # Android uses: mdpi=1x, hdpi=1.5x, xhdpi=2x, xxhdpi=3x, xxxhdpi=4x
        # Launcher icons: 48dp, 72dp, 96dp, 144dp, 192dp
        
        echo "Creating icons for all densities..."
        
        # 1. mipmap-mdpi (48x48 pixels) - 1x
        mkdir -p "$TEMP_DIR/mipmap-mdpi"
        convert original_logo.png -resize 48x48 "$TEMP_DIR/mipmap-mdpi/ic_launcher.webp"
        convert original_logo.png -resize 48x48 "$TEMP_DIR/mipmap-mdpi/ic_launcher_foreground.webp"
        convert original_logo.png -resize 48x48 -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-mdpi/ic_launcher_round.webp"
        
        # 2. mipmap-hdpi (72x72 pixels) - 1.5x
        mkdir -p "$TEMP_DIR/mipmap-hdpi"
        convert original_logo.png -resize 72x72 "$TEMP_DIR/mipmap-hdpi/ic_launcher.webp"
        convert original_logo.png -resize 72x72 "$TEMP_DIR/mipmap-hdpi/ic_launcher_foreground.webp"
        convert original_logo.png -resize 72x72 -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-hdpi/ic_launcher_round.webp"
        
        # 3. mipmap-xhdpi (96x96 pixels) - 2x
        mkdir -p "$TEMP_DIR/mipmap-xhdpi"
        convert original_logo.png -resize 96x96 "$TEMP_DIR/mipmap-xhdpi/ic_launcher.webp"
        convert original_logo.png -resize 96x96 "$TEMP_DIR/mipmap-xhdpi/ic_launcher_foreground.webp"
        convert original_logo.png -resize 96x96 -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-xhdpi/ic_launcher_round.webp"
        
        # 4. mipmap-xxhdpi (144x144 pixels) - 3x
        mkdir -p "$TEMP_DIR/mipmap-xxhdpi"
        convert original_logo.png -resize 144x144 "$TEMP_DIR/mipmap-xxhdpi/ic_launcher.webp"
        convert original_logo.png -resize 144x144 "$TEMP_DIR/mipmap-xxhdpi/ic_launcher_foreground.webp"
        convert original_logo.png -resize 144x144 -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-xxhdpi/ic_launcher_round.webp"
        
        # 5. mipmap-xxxhdpi (192x192 pixels) - 4x
        mkdir -p "$TEMP_DIR/mipmap-xxxhdpi"
        convert original_logo.png -resize 192x192 "$TEMP_DIR/mipmap-xxxhdpi/ic_launcher.webp"
        convert original_logo.png -resize 192x192 "$TEMP_DIR/mipmap-xxxhdpi/ic_launcher_foreground.webp"
        convert original_logo.png -resize 192x192 -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-xxxhdpi/ic_launcher_round.webp"
        
        # 6. mipmap-anydpi (adaptive icons - keep original size)
        mkdir -p "$TEMP_DIR/mipmap-anydpi"
        cp original_logo.png "$TEMP_DIR/mipmap-anydpi/ic_launcher.webp"
        cp original_logo.png "$TEMP_DIR/mipmap-anydpi/ic_launcher_foreground.webp"
        convert original_logo.png -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-anydpi/ic_launcher_round.webp"
        
        # 7. mipmap-anydpi-v26 (adaptive icons for API 26+)
        mkdir -p "$TEMP_DIR/mipmap-anydpi-v26"
        cp original_logo.png "$TEMP_DIR/mipmap-anydpi-v26/ic_launcher.webp"
        cp original_logo.png "$TEMP_DIR/mipmap-anydpi-v26/ic_launcher_foreground.webp"
        convert original_logo.png -alpha set -background none -vignette 0x0 "$TEMP_DIR/mipmap-anydpi-v26/ic_launcher_round.webp"
        
        # Also create PNG versions for compatibility
        echo "Creating PNG versions for compatibility..."
        for density in mdpi hdpi xhdpi xxhdpi xxxhdpi anydpi "anydpi-v26"; do
          if [ -d "$TEMP_DIR/mipmap-$density" ]; then
            # Convert webp to png
            for icon in ic_launcher ic_launcher_foreground ic_launcher_round; do
              webp_file="$TEMP_DIR/mipmap-$density/$icon.webp"
              png_file="$TEMP_DIR/mipmap-$density/$icon.png"
              if [ -f "$webp_file" ]; then
                convert "$webp_file" "$png_file"
              fi
            done
          fi
        done
        
        # Replace old mipmap folders in the project
        echo "Replacing old mipmap folders..."
        
        # Remove existing mipmap folders
        rm -rf app/src/main/res/mipmap-*
        
        # Copy new mipmap folders
        cp -r "$TEMP_DIR"/* app/src/main/res/
        
        # Verify the created icons
        echo "Created icon structure:"
        find app/src/main/res/mipmap-* -type f -name "*.webp" -o -name "*.png" | sort
        
        echo "Icon sizes:"
        for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
          if [ -f "app/src/main/res/mipmap-$density/ic_launcher.webp" ]; then
            size=$(identify -format "%wx%h" "app/src/main/res/mipmap-$density/ic_launcher.webp")
            echo "  mipmap-$density: $size"
          fi
        done
        
        echo "=== LOGO PROCESSING COMPLETE ==="

    # --------------------------------------------------
    # Create strings.xml
    # --------------------------------------------------
    - name: Create strings.xml
      run: |
        echo "Creating strings.xml..."
        
        mkdir -p app/src/main/res/values
        
        {
          echo '<?xml version="1.0" encoding="utf-8"?>'
          echo '<resources>'
          echo "    <string name=\"app_name\">${{ steps.config.outputs.APP_NAME }}</string>"
          echo "    <string name=\"website_url\">${{ steps.config.outputs.WEBSITE_URL }}</string>"
          echo '</resources>'
        } > app/src/main/res/values/strings.xml
        
        echo "strings.xml created"

    # --------------------------------------------------
    # STEP 1: Move MainActivity to new package location
    # --------------------------------------------------
    - name: Move MainActivity to new package
      run: |
        echo "=== STEP 1: MOVING MainActivity ==="
        
        OLD_PACKAGE="${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}"
        NEW_PACKAGE="${{ steps.config.outputs.PACKAGE_NAME }}"
        
        echo "From: $OLD_PACKAGE"
        echo "To: $NEW_PACKAGE"
        
        # Convert to directory paths
        OLD_PATH=$(echo "$OLD_PACKAGE" | tr '.' '/')
        NEW_PATH=$(echo "$NEW_PACKAGE" | tr '.' '/')
        
        echo "Old path: $OLD_PATH"
        echo "New path: $NEW_PATH"
        
        # Find MainActivity.kt or .java
        MAIN_ACTIVITY_KT=$(find app/src/main -name "MainActivity.kt" | head -1)
        MAIN_ACTIVITY_JAVA=$(find app/src/main -name "MainActivity.java" | head -1)
        
        if [ -f "$MAIN_ACTIVITY_KT" ]; then
          echo "Found MainActivity.kt at: $MAIN_ACTIVITY_KT"
          MAIN_ACTIVITY="$MAIN_ACTIVITY_KT"
        elif [ -f "$MAIN_ACTIVITY_JAVA" ]; then
          echo "Found MainActivity.java at: $MAIN_ACTIVITY_JAVA"
          MAIN_ACTIVITY="$MAIN_ACTIVITY_JAVA"
        else
          echo "ERROR: No MainActivity found!"
          exit 1
        fi
        
        # Create new directory
        mkdir -p "app/src/main/java/$NEW_PATH"
        mkdir -p "app/src/main/kotlin/$NEW_PATH" 2>/dev/null || true
        
        # Copy MainActivity to new location
        if [[ "$MAIN_ACTIVITY" == *.kt ]]; then
          NEW_ACTIVITY="app/src/main/kotlin/$NEW_PATH/MainActivity.kt"
          mkdir -p "app/src/main/kotlin/$NEW_PATH"
          cp "$MAIN_ACTIVITY" "$NEW_ACTIVITY"
        else
          NEW_ACTIVITY="app/src/main/java/$NEW_PATH/MainActivity.java"
          mkdir -p "app/src/main/java/$NEW_PATH"
          cp "$MAIN_ACTIVITY" "$NEW_ACTIVITY"
        fi
        
        echo "Copied to: $NEW_ACTIVITY"
        
        # Update package declaration in the new file
        echo "Updating package declaration..."
        if [[ "$NEW_ACTIVITY" == *.kt ]]; then
          sed -i "s|^package $OLD_PACKAGE$|package $NEW_PACKAGE|g" "$NEW_ACTIVITY"
          sed -i "s|import $OLD_PACKAGE\\.|import $NEW_PACKAGE\\.|g" "$NEW_ACTIVITY" 2>/dev/null || true
        else
          sed -i "s|^package $OLD_PACKAGE;|package $NEW_PACKAGE;|g" "$NEW_ACTIVITY"
          sed -i "s|import $OLD_PACKAGE\\.|import $NEW_PACKAGE\\.|g" "$NEW_ACTIVITY" 2>/dev/null || true
        fi
        
        # Remove old MainActivity
        echo "Removing old MainActivity..."
        rm -f "$MAIN_ACTIVITY"
        
        # Delete old directory if empty
        echo "Cleaning old directory..."
        find "app/src/main/java/$(echo "$OLD_PATH" | cut -d'/' -f1)" -type d -empty -delete 2>/dev/null || true
        find "app/src/main/kotlin/$(echo "$OLD_PATH" | cut -d'/' -f1)" -type d -empty -delete 2>/dev/null || true
        
        echo "‚úì MainActivity moved successfully"

    # --------------------------------------------------
    # STEP 2: Update AndroidManifest.xml activity reference ONLY
    # --------------------------------------------------
    - name: Update AndroidManifest.xml activity reference
      run: |
        echo "=== STEP 2: UPDATING AndroidManifest.xml ==="
        
        OLD_PACKAGE="${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}"
        NEW_PACKAGE="${{ steps.config.outputs.PACKAGE_NAME }}"
        
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          echo "Updating activity reference from .$OLD_PACKAGE.MainActivity to .$NEW_PACKAGE.MainActivity"
          
          # Update activity name but keep the package attribute as is
          sed -i "s|android:name=\"\\.$OLD_PACKAGE\\.MainActivity\"|android:name=\"\\.$NEW_PACKAGE\\.MainActivity\"|g" app/src/main/AndroidManifest.xml
          sed -i "s|android:name=\"$OLD_PACKAGE\\.MainActivity\"|android:name=\"$NEW_PACKAGE\\.MainActivity\"|g" app/src/main/AndroidManifest.xml
          sed -i "s|android:name=\"\\.MainActivity\"|android:name=\"\\.$NEW_PACKAGE\\.MainActivity\"|g" app/src/main/AndroidManifest.xml
          
          echo "‚úì AndroidManifest.xml updated (activity reference only)"
          echo "Current manifest activity:"
          grep -i "activity" app/src/main/AndroidManifest.xml | grep -i "name"
        else
          echo "AndroidManifest.xml not found"
        fi

    # --------------------------------------------------
    # STEP 3: Update Gradle files (namespace and applicationId)
    # --------------------------------------------------
    - name: Update Gradle files
      run: |
        echo "=== STEP 3: UPDATING GRADLE FILES ==="
        
        OLD_PACKAGE="${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}"
        NEW_PACKAGE="${{ steps.config.outputs.PACKAGE_NAME }}"
        
        # Update app/build.gradle.kts if exists
        if [ -f "app/build.gradle.kts" ]; then
          echo "Updating app/build.gradle.kts..."
          
          # Update namespace
          sed -i "s|namespace = \"$OLD_PACKAGE\"|namespace = \"$NEW_PACKAGE\"|g" app/build.gradle.kts
          sed -i "s|namespace = '$OLD_PACKAGE'|namespace = \"$NEW_PACKAGE\"|g" app/build.gradle.kts
          
          # Update applicationId
          sed -i "s|applicationId = \"$OLD_PACKAGE\"|applicationId = \"$NEW_PACKAGE\"|g" app/build.gradle.kts
          sed -i "s|applicationId = '$OLD_PACKAGE'|applicationId = \"$NEW_PACKAGE\"|g" app/build.gradle.kts
          
          echo "‚úì app/build.gradle.kts updated"
          echo "Current values:"
          grep -E "(namespace|applicationId)" app/build.gradle.kts
        fi
        
        # Update app/build.gradle if exists (Groovy)
        if [ -f "app/build.gradle" ]; then
          echo "Updating app/build.gradle..."
          sed -i "s|namespace \"$OLD_PACKAGE\"|namespace \"$NEW_PACKAGE\"|g" app/build.gradle
          sed -i "s|namespace '$OLD_PACKAGE'|namespace \"$NEW_PACKAGE\"|g" app/build.gradle
          sed -i "s|applicationId \"$OLD_PACKAGE\"|applicationId \"$NEW_PACKAGE\"|g" app/build.gradle
          sed -i "s|applicationId '$OLD_PACKAGE'|applicationId \"$NEW_PACKAGE\"|g" app/build.gradle
          echo "‚úì app/build.gradle updated"
        fi

    # --------------------------------------------------
    # STEP 4: Create adaptive icon XML files
    # --------------------------------------------------
    - name: Create Adaptive Icon XML Files
      run: |
        echo "=== CREATING ADAPTIVE ICON XML FILES ==="
        
        # Create mipmap-anydpi-v26/ic_launcher.xml for adaptive icons
        mkdir -p app/src/main/res/mipmap-anydpi-v26
        
        cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
          <background android:drawable="@drawable/ic_launcher_background" />
          <foreground android:drawable="@mipmap/ic_launcher_foreground" />
        </adaptive-icon>
        EOF
        
        cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
          <background android:drawable="@drawable/ic_launcher_background" />
          <foreground android:drawable="@mipmap/ic_launcher_foreground" />
        </adaptive-icon>
        EOF
        
        # Create a simple background drawable if it doesn't exist
        mkdir -p app/src/main/res/drawable
        if [ ! -f "app/src/main/res/drawable/ic_launcher_background.xml" ]; then
          cat > app/src/main/res/drawable/ic_launcher_background.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <vector xmlns:android="http://schemas.android.com/apk/res/android"
          android:width="108dp"
          android:height="108dp"
          android:viewportWidth="108"
          android:viewportHeight="108">
            <path
              android:fillColor="#008577"
              android:pathData="M0,0h108v108h-108z" />
        </vector>
        EOF
        fi
        
        echo "‚úì Adaptive icon XML files created"

    # --------------------------------------------------
    # STEP 5: Clean up and verify
    # --------------------------------------------------
    - name: Clean up and verify
      run: |
        echo "=== STEP 5: CLEANUP AND VERIFICATION ==="
        
        # Clean backup files
        find . -type f \( -name "*.backup" -o -name "*.bak" -o -name "*.back" \) -delete 2>/dev/null || true
        
        # Verify MainActivity exists in new location
        NEW_PACKAGE="${{ steps.config.outputs.PACKAGE_NAME }}"
        NEW_PATH=$(echo "$NEW_PACKAGE" | tr '.' '/')
        
        echo "1. Checking MainActivity in new location..."
        if [ -f "app/src/main/kotlin/$NEW_PATH/MainActivity.kt" ]; then
          echo "‚úì Found MainActivity.kt at: app/src/main/kotlin/$NEW_PATH/MainActivity.kt"
          echo "Package in file:"
          grep "^package" "app/src/main/kotlin/$NEW_PATH/MainActivity.kt"
        elif [ -f "app/src/main/java/$NEW_PATH/MainActivity.java" ]; then
          echo "‚úì Found MainActivity.java at: app/src/main/java/$NEW_PATH/MainActivity.java"
          echo "Package in file:"
          grep "^package" "app/src/main/java/$NEW_PATH/MainActivity.java"
        else
          echo "‚úó ERROR: MainActivity not found in new location!"
          exit 1
        fi
        
        # Verify AndroidManifest.xml
        echo ""
        echo "2. AndroidManifest.xml activity:"
        grep -i "activity" app/src/main/AndroidManifest.xml 2>/dev/null | grep -i "name" || echo "No activity found"
        
        # Verify Gradle files
        echo ""
        echo "3. Gradle configuration:"
        if [ -f "app/build.gradle.kts" ]; then
          grep -E "(namespace|applicationId)" app/build.gradle.kts || echo "No namespace/applicationId found"
        elif [ -f "app/build.gradle" ]; then
          grep -E "(namespace|applicationId)" app/build.gradle || echo "No namespace/applicationId found"
        fi
        
        # Verify icons were created
        echo ""
        echo "4. Icon structure verification:"
        echo "Created mipmap directories:"
        ls -la app/src/main/res/ | grep mipmap
        
        echo ""
        echo "Icon files in each directory:"
        for dir in app/src/main/res/mipmap-*; do
          if [ -d "$dir" ]; then
            echo "  $(basename "$dir"):"
            ls "$dir" | head -5
          fi
        done

    # --------------------------------------------------
    # Build APK
    # --------------------------------------------------
    - name: Build Signed Release APK
      run: |
        echo "=== BUILDING APK ==="
        
        # Clean
        rm -rf app/build .gradle build 2>/dev/null || true
        
        # Make gradlew executable
        if [ -f "gradlew" ]; then
          chmod +x gradlew
        else
          gradle wrapper --gradle-version 8.0
          chmod +x gradlew
        fi
        
        # Build
        echo "Building release APK..."
        ./gradlew clean assembleRelease
        
        echo "Build completed."
        
        # Show APK
        APK_FILE=$(find app/build/outputs/apk -name "*release*.apk" -type f | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "‚úì APK generated: $APK_FILE"
          ls -lh "$APK_FILE"
        else
          echo "‚úó No APK found!"
          exit 1
        fi

    # --------------------------------------------------
    # Verify APK
    # --------------------------------------------------
    - name: Verify APK
      run: |
        echo "=== VERIFYING APK ==="
        
        APK_FILE=$(find app/build/outputs/apk -name "*release*.apk" -type f | head -1)
        
        if [ -f "$APK_FILE" ]; then
          echo "APK: $APK_FILE"
          
          if command -v aapt &> /dev/null; then
            echo "APK info:"
            aapt dump badging "$APK_FILE" | grep -E "(package|application-label|launchable-activity)" || true
          fi
        fi

    # --------------------------------------------------
    # Upload APK
    # --------------------------------------------------
    - name: Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.config.outputs.APP_NAME }}-${{ steps.config.outputs.USER_ID }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 7

    # --------------------------------------------------
    # Completion
    # --------------------------------------------------
    - name: Notify completion
      run: |
        echo "‚úÖ Build completed successfully!"
        echo "üì± App Name: ${{ steps.config.outputs.APP_NAME }}"
        echo "üì¶ Package: ${{ steps.config.outputs.PACKAGE_NAME }}"
        echo "üåê Website: ${{ steps.config.outputs.WEBSITE_URL }}"
        echo "üé® Icons created for all Android densities"
