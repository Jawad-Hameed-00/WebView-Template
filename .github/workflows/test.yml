name: Android App Builder (Signed APK)

on:
  workflow_dispatch:
    inputs:
      build_url:
        description: 'URL to build.json'
        required: true
        default: 'https://savist.online/build.json'

env:
  BUILD_CONFIG_URL: ${{ github.event.inputs.build_url }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # Checkout repository
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: master  # or master

    # --------------------------------------------------
    # Set up JDK
    # --------------------------------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # --------------------------------------------------
    # Download build configuration
    # --------------------------------------------------
    - name: Download build configuration
      run: |
        echo "Downloading build config from: $BUILD_CONFIG_URL"
        curl -s -o build_config.json "$BUILD_CONFIG_URL"
        echo "Build config content:"
        cat build_config.json

    # --------------------------------------------------
    # Parse JSON configuration
    # --------------------------------------------------
    - name: Parse build configuration
      id: config
      run: |
        echo "Extracting build parameters..."
        
        # Extract values
        WEBSITE_URL=$(jq -r '.website_url' build_config.json)
        APP_NAME=$(jq -r '.app_name' build_config.json)
        PACKAGE_NAME=$(jq -r '.package_name' build_config.json)
        LOGO_URL=$(jq -r '.logo_url' build_config.json)
        USER_ID=$(jq -r '.user_id' build_config.json)
        
        # Output variables
        echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_OUTPUT
        echo "LOGO_URL=$LOGO_URL" >> $GITHUB_OUTPUT
        echo "USER_ID=$USER_ID" >> $GITHUB_OUTPUT
        
        echo "Parsed values:"
        echo "App Name: $APP_NAME"
        echo "Package: $PACKAGE_NAME"
        echo "Website: $WEBSITE_URL"

    # --------------------------------------------------
    # Find original package name from existing project
    # --------------------------------------------------
    - name: Find original package name
      id: find_package
      run: |
        echo "Finding original package name..."
        
        # Try to get from AndroidManifest.xml
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          ORIGINAL_PACKAGE=$(grep -o 'package="[^"]*"' app/src/main/AndroidManifest.xml | sed 's/package="//' | sed 's/"//')
          echo "Found in AndroidManifest.xml: $ORIGINAL_PACKAGE"
        elif [ -f "app/build.gradle" ]; then
          # Try to get from build.gradle
          ORIGINAL_PACKAGE=$(grep -o "namespace '[^']*'" app/build.gradle | sed "s/namespace '//" | sed "s/'//" || 
                            grep -o 'applicationId "[^"]*"' app/build.gradle | sed 's/applicationId "//' | sed 's/"//')
          echo "Found in build.gradle: $ORIGINAL_PACKAGE"
        else
          # Try to find from Java/Kotlin files
          JAVA_FILE=$(find app/src/main/java -name "*.java" -o -name "*.kt" | head -1)
          if [ -f "$JAVA_FILE" ]; then
            ORIGINAL_PACKAGE=$(grep -o 'package [^;]*' "$JAVA_FILE" | sed 's/package //')
            echo "Found in Java file: $ORIGINAL_PACKAGE"
          else
            ORIGINAL_PACKAGE="com.yourapp.app"
            echo "Using default: $ORIGINAL_PACKAGE"
          fi
        fi
        
        echo "ORIGINAL_PACKAGE=$ORIGINAL_PACKAGE" >> $GITHUB_OUTPUT
        echo "NEW_PACKAGE=${{ steps.config.outputs.PACKAGE_NAME }}" >> $GITHUB_OUTPUT
        
        echo "Original package: $ORIGINAL_PACKAGE"
        echo "New package: ${{ steps.config.outputs.PACKAGE_NAME }}"

    # --------------------------------------------------
    # Setup Android SDK
    # --------------------------------------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # --------------------------------------------------
    # Create keystore
    # --------------------------------------------------
    - name: Create release keystore
      run: |
        echo "Creating keystore..."
        keytool -genkeypair \
          -keystore release.jks \
          -alias release \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android123 \
          -keypass android123 \
          -dname "CN=AppBuilder, OU=Mobile, O=Savist, L=Bahawalpur, S=Punjab, C=PK"
        echo "Keystore created"

    # --------------------------------------------------
    # Configure signing
    # --------------------------------------------------
    - name: Configure signing
      run: |
        echo "Configuring signing..."
        
        # Add signing config to gradle.properties
        echo "" >> gradle.properties
        echo "# Auto-generated signing config" >> gradle.properties
        echo "RELEASE_STORE_FILE=$(pwd)/release.jks" >> gradle.properties
        echo "RELEASE_STORE_PASSWORD=android123" >> gradle.properties
        echo "RELEASE_KEY_ALIAS=release" >> gradle.properties
        echo "RELEASE_KEY_PASSWORD=android123" >> gradle.properties
        
        # Also update app/build.gradle if needed
        if [ -f "app/build.gradle" ]; then
          # Check if signing configs already exist
          if ! grep -q "signingConfigs" app/build.gradle; then
            echo "Adding signing config to build.gradle..."
            
            # Find the android block and add signingConfigs after it
            sed -i '/android {/a\
            signingConfigs {\
              release {\
            storeFile file("../release.jks")\
            storePassword "android123"\
            keyAlias "release"\
            keyPassword "android123"\
        }\
            }' app/build.gradle
            
            # Update buildTypes to use release signing
            sed -i 's/release {/release {\n            signingConfig signingConfigs.release/' app/build.gradle
          fi
        fi

    # --------------------------------------------------
    # Download and update app logo
    # --------------------------------------------------
    - name: Download and update app logo
      run: |
        echo "Downloading logo from: ${{ steps.config.outputs.LOGO_URL }}"
        
        # Install ImageMagick for image processing
        sudo apt-get update
        sudo apt-get install -y imagemagick
        
        # Download logo
        wget -O downloaded_logo.png "${{ steps.config.outputs.LOGO_URL }}"
        
        # Update launcher icons (only if they exist)
        if [ -d "app/src/main/res" ]; then
          # Find and update existing launcher icons
          find app/src/main/res -name "ic_launcher.png" -o -name "ic_launcher.jpg" -o -name "ic_launcher.jpeg" -o -name "ic_launcher.webp" | while read icon; do
            echo "Updating: $icon"
            dir=$(dirname "$icon")
            
            # Get dimensions from filename or directory
            if echo "$dir" | grep -q "mipmap-hdpi"; then
              convert downloaded_logo.png -resize 72x72 "$icon"
            elif echo "$dir" | grep -q "mipmap-mdpi"; then
              convert downloaded_logo.png -resize 48x48 "$icon"
            elif echo "$dir" | grep -q "mipmap-xhdpi"; then
              convert downloaded_logo.png -resize 96x96 "$icon"
            elif echo "$dir" | grep -q "mipmap-xxhdpi"; then
              convert downloaded_logo.png -resize 144x144 "$icon"
            elif echo "$dir" | grep -q "mipmap-xxxhdpi"; then
              convert downloaded_logo.png -resize 192x192 "$icon"
            else
              # Default resize
              convert downloaded_logo.png -resize 512x512 "$icon"
            fi
          done
          
          # Also update any round launcher icons
          find app/src/main/res -name "ic_launcher_round.png" -o -name "ic_launcher_round.jpg" | while read icon; do
            echo "Updating round icon: $icon"
            convert downloaded_logo.png -resize 512x512 -alpha set -background none -vignette 0x0 "$icon"
          done
        else
          echo "Warning: No res directory found"
        fi
        
        echo "Logo updated"

    # --------------------------------------------------
    # Update strings.xml
    # --------------------------------------------------
    - name: Update strings.xml
      run: |
        echo "Updating strings.xml..."
        
        # Find strings.xml
        STRINGS_FILE=$(find app/src/main/res -name "strings.xml" | head -1)
        
        if [ -f "$STRINGS_FILE" ]; then
          echo "Found strings.xml at: $STRINGS_FILE"
          
          # Backup original
          cp "$STRINGS_FILE" "${STRINGS_FILE}.backup"
          
          # Update app_name
          if grep -q 'name="app_name"' "$STRINGS_FILE"; then
            sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">${{ steps.config.outputs.APP_NAME }}</string>|g" "$STRINGS_FILE"
          else
            # Add app_name if it doesn't exist
            sed -i "/<\/resources>/i\    <string name=\"app_name\">${{ steps.config.outputs.APP_NAME }}</string>" "$STRINGS_FILE"
          fi
          
          # Update website_url
          if grep -q 'name="website_url"' "$STRINGS_FILE"; then
            sed -i "s|<string name=\"website_url\">.*</string>|<string name=\"website_url\">${{ steps.config.outputs.WEBSITE_URL }}</string>|g" "$STRINGS_FILE"
          else
            # Add website_url if it doesn't exist
            sed -i "/<\/resources>/i\    <string name=\"website_url\">${{ steps.config.outputs.WEBSITE_URL }}</string>" "$STRINGS_FILE"
          fi
          
          echo "Updated strings.xml:"
          cat "$STRINGS_FILE"
        else
          echo "Warning: strings.xml not found"
        fi

    # --------------------------------------------------
    # Update package name in all files
    # --------------------------------------------------
    - name: Update package name
      run: |
        echo "Updating package name..."
        echo "From: ${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}"
        echo "To: ${{ steps.config.outputs.PACKAGE_NAME }}"
        
        OLD_PACKAGE="${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}"
        NEW_PACKAGE="${{ steps.config.outputs.PACKAGE_NAME }}"
        
        # Escape dots for regex
        OLD_PACKAGE_ESCAPED=$(echo "$OLD_PACKAGE" | sed 's/\./\\./g')
        
        # 1. Update AndroidManifest.xml
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          echo "Updating AndroidManifest.xml..."
          sed -i "s/package=\"$OLD_PACKAGE\"/package=\"$NEW_PACKAGE\"/g" app/src/main/AndroidManifest.xml
          sed -i "s/android:name=\"\./$OLD_PACKAGE\./g" app/src/main/AndroidManifest.xml
          sed -i "s/android:name=\"$OLD_PACKAGE\./android:name=\"$NEW_PACKAGE\./g" app/src/main/AndroidManifest.xml
        fi
        
        # 2. Update build.gradle (applicationId)
        if [ -f "app/build.gradle" ]; then
          echo "Updating build.gradle..."
          
          # Update namespace if exists
          sed -i "s/namespace ['\"]$OLD_PACKAGE['\"]/namespace '$NEW_PACKAGE'/g" app/build.gradle
          
          # Update applicationId
          sed -i "s/applicationId ['\"]$OLD_PACKAGE['\"]/applicationId '$NEW_PACKAGE'/g" app/build.gradle
          
          # Also update defaultConfig if it references the old package
          sed -i "s/applicationId .*$OLD_PACKAGE.*/applicationId '$NEW_PACKAGE'/g" app/build.gradle
        fi
        
        # 3. Update Java/Kotlin files
        echo "Updating Java/Kotlin files..."
        find app/src/main/java app/src/main/kotlin -type f \( -name "*.java" -o -name "*.kt" \) 2>/dev/null | while read file; do
          echo "  Updating: $file"
          
          # Update package declaration
          sed -i "s/^package $OLD_PACKAGE;/package $NEW_PACKAGE;/g" "$file"
          
          # Update imports
          sed -i "s/import $OLD_PACKAGE\./import $NEW_PACKAGE\./g" "$file"
          
          # Update R imports
          sed -i "s/import $OLD_PACKAGE\.R;/import $NEW_PACKAGE\.R;/g" "$file"
          sed -i "s/import $OLD_PACKAGE\.databinding/import $NEW_PACKAGE\.databinding/g" "$file"
        done
        
        # 4. Update XML files
        echo "Updating XML files..."
        find . -type f -name "*.xml" | grep -v ".gradle" | while read file; do
          # Update custom view references
          sed -i "s/$OLD_PACKAGE\./$NEW_PACKAGE\./g" "$file"
        done
        
        # 5. Move source files to new package structure
        echo "Moving source files to new package structure..."
        
        OLD_PATH=$(echo "$OLD_PACKAGE" | sed 's/\./\//g')
        NEW_PATH=$(echo "$NEW_PACKAGE" | sed 's/\./\//g')
        
        if [ -d "app/src/main/java/$OLD_PATH" ]; then
          echo "Moving from: app/src/main/java/$OLD_PATH"
          echo "Moving to: app/src/main/java/$NEW_PATH"
          
          # Create new directory
          mkdir -p "app/src/main/java/$NEW_PATH"
          
          # Copy files
          cp -r "app/src/main/java/$OLD_PATH/"* "app/src/main/java/$NEW_PATH/" 2>/dev/null || true
          
          # Clean up old directory (keep if empty)
          find "app/src/main/java/$(echo "$OLD_PATH" | cut -d'/' -f1)" -type d -empty -delete 2>/dev/null || true
        fi
        
        echo "Package name update complete"

    # --------------------------------------------------
    # Update app name in other places
    # --------------------------------------------------
    - name: Update app name in other files
      run: |
        echo "Updating app name in other files..."
        
        # Update settings.gradle
        if [ -f "settings.gradle" ] || [ -f "settings.gradle.kts" ]; then
          echo "Updating rootProject.name in settings.gradle..."
          sed -i "s/rootProject.name = \".*\"/rootProject.name = \"${{ steps.config.outputs.APP_NAME }}\"/g" settings.gradle* 2>/dev/null || true
        fi
        
        # Update build.gradle files for app name
        find . -name "*.gradle" -o -name "*.gradle.kts" | while read file; do
          sed -i "s/\"${{ steps.find_package.outputs.ORIGINAL_PACKAGE }}\"/\"${{ steps.config.outputs.PACKAGE_NAME }}\"/g" "$file"
        done

    # --------------------------------------------------
    # Build signed release APK
    # --------------------------------------------------
    - name: Build Signed Release APK
      run: |
        echo "Building signed release APK..."
        
        # Make gradlew executable
        chmod +x gradlew 2>/dev/null || echo "gradlew not found, using gradle wrapper"
        
        # Clean previous builds
        ./gradlew clean || echo "Clean failed, continuing..."
        
        # Build release APK
        ./gradlew assembleRelease
        
        echo "Build completed."
        
        # Show APK files
        echo "Generated APK files:"
        find . -name "*.apk" -type f | while read file; do
          echo "  - $file ($(ls -lh "$file" | awk '{print $5}'))"
        done

    # --------------------------------------------------
    # Verify APK
    # --------------------------------------------------
    - name: Verify APK
      run: |
        echo "Verifying APK..."
        
        # Find the release APK
        APK_FILE=$(find app/build/outputs/apk -name "*release*.apk" -type f | head -1)
        
        if [ -f "$APK_FILE" ]; then
          echo "APK found: $APK_FILE"
          echo "Size: $(ls -lh "$APK_FILE" | awk '{print $5}')"
          
          # Try to get package info using aapt2
          if command -v aapt2 &> /dev/null; then
            echo "APK contents:"
            aapt2 dump badging "$APK_FILE" | grep -E "(package|application-label|launchable-activity)" || true
          fi
        else
          echo "ERROR: No APK file found!"
          find app/build -name "*.apk" -type f
          exit 1
        fi

    # --------------------------------------------------
    # Upload APK as artifact
    # --------------------------------------------------
    - name: Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.config.outputs.APP_NAME }}-${{ steps.config.outputs.USER_ID }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 7

    # --------------------------------------------------
    # Notify completion
    # --------------------------------------------------
    - name: Notify build completion
      run: |
        echo "Build completed successfully!"
        echo "App Name: ${{ steps.config.outputs.APP_NAME }}"
        echo "Package: ${{ steps.config.outputs.PACKAGE_NAME }}"
        echo "User ID: ${{ steps.config.outputs.USER_ID }}"
