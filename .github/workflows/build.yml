name: Android App Builder (Signed APK)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ‚úÖ Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # ‚úÖ Download build.json
    - name: Download build.json
      run: |
        wget -O build.json https://savist.online/build.json
        cat build.json

    # ‚úÖ Parse JSON
    - name: Parse config
      id: config
      run: |
        echo "website_url=$(jq -r '.website_url' build.json)" >> $GITHUB_OUTPUT
        echo "app_name=$(jq -r '.app_name' build.json)" >> $GITHUB_OUTPUT
        echo "package_name=$(jq -r '.package_name' build.json)" >> $GITHUB_OUTPUT
        echo "logo_url=$(jq -r '.logo_url' build.json)" >> $GITHUB_OUTPUT
        echo "user_id=$(jq -r '.user_id' build.json)" >> $GITHUB_OUTPUT

    # ‚úÖ Download Logo
    - name: Download App Logo
      run: |
        mkdir -p app/src/main/res/drawable
        wget -O app/src/main/res/drawable/app_logo.png "${{ steps.config.outputs.logo_url }}"

    # ‚úÖ Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # ‚úÖ Update strings
    - name: Update strings.xml
      run: |
        sed -i "s|My App|${{ steps.config.outputs.app_name }}|g" app/src/main/res/values/strings.xml
        sed -i "s|https://example.com|${{ steps.config.outputs.website_url }}|g" app/src/main/res/values/strings.xml

    # ‚úÖ Update package name
    - name: Update package name
      run: |
        OLD_PACKAGE="com.yourapp.app"
        NEW_PACKAGE="${{ steps.config.outputs.package_name }}"

        find . -type f \( -name "*.java" -o -name "*.kt" -o -name "*.xml" -o -name "*.gradle" \) \
          -exec sed -i "s/$OLD_PACKAGE/$NEW_PACKAGE/g" {} +

    # ‚úÖ Build Release APK
    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease

    # üîê Create Keystore
    - name: Create Keystore
      run: |
        keytool -genkeypair -v \
          -keystore release.jks \
          -alias release \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android \
          -keypass android \
          -dname "CN=Jawad, OU=Android, O=Savist, L=Pakistan, S=Punjab, C=PK"

    # üîê Sign APK (OFFICIAL WAY)
    - name: Sign APK
      run: |
        APK_PATH=app/build/outputs/apk/release/app-release-unsigned.apk
        SIGNED_APK=app/build/outputs/apk/release/${{ steps.config.outputs.app_name }}-signed.apk

        $ANDROID_SDK_ROOT/build-tools/*/apksigner sign \
          --ks release.jks \
          --ks-key-alias release \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out $SIGNED_APK \
          $APK_PATH

    # ‚úÖ Verify Signature
    - name: Verify APK
      run: |
        $ANDROID_SDK_ROOT/build-tools/*/apksigner verify \
          app/build/outputs/apk/release/${{ steps.config.outputs.app_name }}-signed.apk

    # üì¶ Upload SIGNED APK
    - name: Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: Signed-${{ steps.config.outputs.app_name }}-${{ steps.config.outputs.user_id }}
        path: app/build/outputs/apk/release/*-signed.apk
