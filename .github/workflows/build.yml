name: Android App Builder

on:
  workflow_dispatch:
    inputs:
      build_url:
        description: 'URL to build.json'
        required: true
        default: 'https://savist.online/build.json'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
        
    - name: Download build configuration
      run: |
        wget -O build_config.json ${{ github.event.inputs.build_url }}
        echo "Build config downloaded"
        
    - name: Parse build configuration
      id: config
      run: |
        BUILD_CONFIG=$(cat build_config.json)
        echo "::set-output name=website_url::$(echo $BUILD_CONFIG | jq -r '.website_url')"
        echo "::set-output name=app_name::$(echo $BUILD_CONFIG | jq -r '.app_name')"
        echo "::set-output name=package_name::$(echo $BUILD_CONFIG | jq -r '.package_name')"
        echo "::set-output name=logo_url::$(echo $BUILD_CONFIG | jq -r '.logo_url')"
        
    - name: Download app logo
      run: |
        wget -O app/src/main/res/drawable/app_logo.png ${{ steps.config.outputs.logo_url }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Replace strings in XML files
      run: |
        # Replace app name
        sed -i "s/My App/${{ steps.config.outputs.app_name }}/g" app/src/main/res/values/strings.xml
        
        # Replace website URL
        sed -i "s|https://example.com|${{ steps.config.outputs.website_url }}|g" app/src/main/res/values/strings.xml
        
        # Update package name
        find . -name "*.java" -type f -exec sed -i "s/com\.yourapp\.app/${{ steps.config.outputs.package_name }}/g" {} +
        find . -name "*.xml" -type f -exec sed -i "s/com\.yourapp\.app/${{ steps.config.outputs.package_name }}/g" {} +
        find . -name "*.gradle" -type f -exec sed -i "s/com\.yourapp\.app/${{ steps.config.outputs.package_name }}/g" {} +
        
        # Update AndroidManifest.xml
        sed -i "s/com\.yourapp\.app/${{ steps.config.outputs.package_name }}/g" app/src/main/AndroidManifest.xml
        
    - name: Update build.gradle
      run: |
        sed -i "s/applicationId \"com\.yourapp\.app\"/applicationId \"${{ steps.config.outputs.package_name }}\"/g" app/build.gradle
        
    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease
        
    - name: Sign APK
      run: |
        # Create keystore (use your own keystore in production)
        keytool -genkey -v -keystore my-release-key.jks \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -alias my-alias \
          -storepass password123 -keypass password123 \
          -dname "CN=App Builder, OU=Mobile, O=Company, L=City, S=State, C=US"
          
        # Sign the APK
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore my-release-key.jks \
          app/build/outputs/apk/release/app-release-unsigned.apk \
          my-alias \
          -storepass password123 -keypass password123
          
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: signed-app
        path: app/build/outputs/apk/release/app-release-unsigned.apk
