name: Android Build & Notify Server

on:
  workflow_dispatch:
    inputs:
      build_url:
        description: 'URL to build.json'
        required: true
        default: 'https://savist.online/build.json'

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SERVER_URL: https://savist.online/receive_workflow.php
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    # --------------------------------------------------
    # Checkout repository
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------------------------------
    # Setup JDK 17
    # --------------------------------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # --------------------------------------------------
    # Download build.json
    # --------------------------------------------------
    - name: Download build.json
      run: |
        wget -O build.json "${{ github.event.inputs.build_url }}"
        cat build.json

    # --------------------------------------------------
    # Parse build.json
    # --------------------------------------------------
    - name: Parse build configuration
      id: config
      run: |
        echo "APP_NAME=$(jq -r '.app_name' build.json)" >> $GITHUB_ENV
        echo "PACKAGE_NAME=$(jq -r '.package_name' build.json)" >> $GITHUB_ENV
        echo "LOGO_URL=$(jq -r '.logo_url' build.json)" >> $GITHUB_ENV
        echo "USER_ID=$(jq -r '.user_id' build.json)" >> $GITHUB_ENV

    # --------------------------------------------------
    # Setup Android SDK
    # --------------------------------------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # --------------------------------------------------
    # Download App Logo
    # --------------------------------------------------
    - name: Download app logo
      run: |
        mkdir -p app/src/main/res/drawable
        wget -O app/src/main/res/drawable/app_logo.png "$LOGO_URL"

    # --------------------------------------------------
    # Update app name and package name
    # --------------------------------------------------
    - name: Update app strings
      run: |
        sed -i "s|My App|$APP_NAME|g" app/src/main/res/values/strings.xml
        OLD_PACKAGE="com.jawadhameed.webviewtemplate"
        find . -type f \( -name "*.kt" -o -name "*.java" -o -name "*.xml" -o -name "*.gradle" \) \
          -exec sed -i "s|$OLD_PACKAGE|$PACKAGE_NAME|g" {} +

    # --------------------------------------------------
    # Create a keystore (for demo purposes)
    # --------------------------------------------------
    - name: Create Keystore
      run: |
        keytool -genkeypair -v \
          -keystore release.jks \
          -alias release \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android \
          -keypass android \
          -dname "CN=Jawad, OU=Android, O=Savist, L=Bahawalpur, S=Punjab, C=PK"

    # --------------------------------------------------
    # Build release APK
    # --------------------------------------------------
    - name: Build Release APK
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease

    # --------------------------------------------------
    # Sign APK
    # --------------------------------------------------
    - name: Sign APK
      run: |
        UNSIGNED=app/build/outputs/apk/release/app-release-unsigned.apk
        SIGNED=app/build/outputs/apk/release/${APP_NAME}-signed.apk
        $ANDROID_SDK_ROOT/build-tools/*/apksigner sign \
          --ks release.jks \
          --ks-key-alias release \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out "$SIGNED" \
          "$UNSIGNED"

    # --------------------------------------------------
    # Upload APK as artifact
    # --------------------------------------------------
    - name: Upload signed APK
      uses: actions/upload-artifact@v4
      with:
        name: "${APP_NAME}-${USER_ID}"
        path: app/build/outputs/apk/release/*-signed.apk

    # --------------------------------------------------
    # Notify server with run_id
    # --------------------------------------------------
    - name: Notify server
      run: |
        RUN_ID=${{ github.run_id }}
        curl -X POST "$SERVER_URL" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"$RUN_ID\", \"repo\": \"${{ github.repository }}\", \"workflow\": \"Android Build & Notify Server\"}"
