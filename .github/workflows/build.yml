name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID'
        required: true
      website_url:
        description: 'Website URL'
        required: true
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      logo_url:
        description: 'Logo URL'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Download and replace logo
      run: |
        curl -o app/src/main/res/mipmap-xxxhdpi/ic_launcher.png ${{ github.event.inputs.logo_url }}
        curl -o app/src/main/res/mipmap-xxhdpi/ic_launcher.png ${{ github.event.inputs.logo_url }}
        curl -o app/src/main/res/mipmap-xhdpi/ic_launcher.png ${{ github.event.inputs.logo_url }}
        curl -o app/src/main/res/mipmap-hdpi/ic_launcher.png ${{ github.event.inputs.logo_url }}
        curl -o app/src/main/res/mipmap-mdpi/ic_launcher.png ${{ github.event.inputs.logo_url }}
        
    - name: Update strings.xml
      run: |
        # Update app name
        sed -i "s/<string name=\"app_name\">.*<\/string>/<string name=\"app_name\">${{ github.event.inputs.app_name }}<\/string>/g" app/src/main/res/values/strings.xml
        
        # Update website URL
        sed -i "s/<string name=\"website_url\">.*<\/string>/<string name=\"website_url\">${{ github.event.inputs.website_url }}<\/string>/g" app/src/main/res/values/strings.xml
        
    - name: Update package name
      uses: BetterQA/github-action-rename-package@v1
      with:
        current-package-name: 'com.example.app'
        new-package-name: '${{ github.event.inputs.package_name }}'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease
        
    - name: Sign APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # Use jarsigner or apksigner to sign the APK
        # Assuming you have your keystore.jks in the repository
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore keystore.jks \
          -storepass $KEYSTORE_PASSWORD \
          -keypass $KEY_PASSWORD \
          app/build/outputs/apk/release/app-release-unsigned.apk \
          key-alias
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: app/build/outputs/apk/release/*.apk
        
    - name: Notify completion via webhook
      run: |
        curl -X POST https://savist.online/update_build_status.php \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"${{ github.event.inputs.build_id }}\",\"status\":\"completed\",\"run_id\":\"${{ github.run_id }}\"}"
