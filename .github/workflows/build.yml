name: Build Android App

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID'
        required: true
        type: string
      website_url:
        description: 'Website URL'
        required: true
        type: string
      app_name:
        description: 'App Name'
        required: true
        type: string
      package_name:
        description: 'Package Name'
        required: true
        type: string
      logo_url:
        description: 'Logo URL'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check inputs
      run: |
        echo "=== Build Parameters ==="
        echo "Build ID: ${{ github.event.inputs.build_id }}"
        echo "App Name: ${{ github.event.inputs.app_name }}"
        echo "Package: ${{ github.event.inputs.package_name }}"
        echo "Website: ${{ github.event.inputs.website_url }}"
        echo "Logo URL: ${{ github.event.inputs.logo_url }}"
        echo "========================="
    
    - name: Notify build started
      run: |
        curl -X POST "https://savist.online/update_build_status.php" \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"${{ github.event.inputs.build_id }}\",\"status\":\"processing\",\"run_id\":\"$GITHUB_RUN_ID\"}" \
          --silent || echo "Notification failed - continuing"
    
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Create simple Android project structure
      run: |
        echo "Creating Android project..."
        
        # Create directories
        mkdir -p app/src/main/res/{layout,values,drawable-xxhdpi}
        
        # Create package directory from package name
        PACKAGE_PATH=$(echo "${{ github.event.inputs.package_name }}" | tr '.' '/')
        mkdir -p "app/src/main/java/$PACKAGE_PATH"
        
        echo "Package path: $PACKAGE_PATH"
    
    - name: Create Android files
      run: |
        echo "Creating Android app files..."
        
        PACKAGE_PATH=$(echo "${{ github.event.inputs.package_name }}" | tr '.' '/')
        
        # 1. Create strings.xml
        cat > app/src/main/res/values/strings.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">APP_NAME_PLACEHOLDER</string>
    <string name="website_url">WEBSITE_URL_PLACEHOLDER</string>
</resources>
EOF
        
        # Replace placeholders
        sed -i "s|APP_NAME_PLACEHOLDER|${{ github.event.inputs.app_name }}|g" app/src/main/res/values/strings.xml
        sed -i "s|WEBSITE_URL_PLACEHOLDER|${{ github.event.inputs.website_url }}|g" app/src/main/res/values/strings.xml
        
        # 2. Create MainActivity.kt
        cat > "app/src/main/java/$PACKAGE_PATH/MainActivity.kt" << EOF
package ${{ github.event.inputs.package_name }}

import android.annotation.SuppressLint
import android.os.Bundle
import android.webkit.WebView
import android.webkit.WebViewClient
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
    
    @SuppressLint("SetJavaScriptEnabled")
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        val webView: WebView = findViewById(R.id.webView)
        webView.webViewClient = WebViewClient()
        webView.settings.javaScriptEnabled = true
        webView.settings.domStorageEnabled = true
        webView.settings.allowContentAccess = true
        webView.settings.allowFileAccess = true
        
        val websiteUrl = resources.getString(R.string.website_url)
        webView.loadUrl(websiteUrl)
    }
    
    override fun onBackPressed() {
        val webView: WebView = findViewById(R.id.webView)
        if (webView.canGoBack()) {
            webView.goBack()
        } else {
            super.onBackPressed()
        }
    }
}
EOF
        
        # 3. Create activity_main.xml
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical">
    
    <WebView
        android:id="@+id/webView"
        android:layout_width="match_parent"
        android:layout_height="match_parent" />
    
</LinearLayout>
EOF
        
        # 4. Create AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << EOF
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="${{ github.event.inputs.package_name }}">
    
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    
    <application
        android:allowBackup="true"
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar"
        android:usesCleartextTraffic="true">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:configChanges="orientation|screenSize|keyboardHidden"
            android:windowSoftInputMode="adjustResize">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        
    </application>
    
</manifest>
EOF
        
        echo "Android files created"
    
    - name: Download logo if provided
      if: github.event.inputs.logo_url != ''
      run: |
        echo "Downloading logo from: ${{ github.event.inputs.logo_url }}"
        curl -L -o app/src/main/res/drawable-xxhdpi/ic_launcher.png "${{ github.event.inputs.logo_url }}" || echo "Logo download failed"
        
        # Copy to other density folders for Android
        mkdir -p app/src/main/res/drawable-{xhdpi,hdpi,mdpi}
        cp app/src/main/res/drawable-xxhdpi/ic_launcher.png app/src/main/res/drawable-xhdpi/ic_launcher.png || true
        cp app/src/main/res/drawable-xxhdpi/ic_launcher.png app/src/main/res/drawable-hdpi/ic_launcher.png || true
        cp app/src/main/res/drawable-xxhdpi/ic_launcher.png app/src/main/res/drawable-mdpi/ic_launcher.png || true
    
    - name: Create default logo if needed
      if: github.event.inputs.logo_url == ''
      run: |
        echo "Creating default icon..."
        # Create a simple placeholder
        echo "Default icon" > app/src/main/res/drawable-xxhdpi/ic_launcher.txt
        echo "Default icon" > app/src/main/res/drawable-xhdpi/ic_launcher.txt
        echo "Default icon" > app/src/main/res/drawable-hdpi/ic_launcher.txt
        echo "Default icon" > app/src/main/res/drawable-mdpi/ic_launcher.txt
    
    - name: Create build.gradle files
      run: |
        # Create app/build.gradle
        cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace 'com.example.app'
    compileSdk 33

    defaultConfig {
        applicationId "com.example.app"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    
    kotlinOptions {
        jvmTarget = '1.8'
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.10.1'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.9.0'
}
EOF
        
        # Update package name in build.gradle
        sed -i "s|applicationId \".*\"|applicationId \"${{ github.event.inputs.package_name }}\"|g" app/build.gradle
        sed -i "s|namespace '.*'|namespace '${{ github.event.inputs.package_name }}'|g" app/build.gradle
        
        # Create root build.gradle
        cat > build.gradle << 'EOF'
// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:7.4.2'
        classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.10'
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF
        
        # Create settings.gradle
        echo "include ':app'" > settings.gradle
        
        # Create gradle wrapper properties
        mkdir -p gradle/wrapper
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
        
        echo "Gradle files created"
    
    - name: Create gradle wrapper script
      run: |
        # Create gradlew script
        cat > gradlew << 'EOF'
#!/usr/bin/env sh

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn () {
    echo "$*"
}

die () {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
  NONSTOP* )
    nonstop=true
    ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executable
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME"
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        ulimit -n $MAX_FD
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    else
        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# For Cygwin or MSYS, switch paths to Windows format before running java
if [ "$cygwin" = "true" -o "$msys" = "true" ] ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`
    JAVACMD=`cygpath --unix "$JAVACMD"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_USER_HOME" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_USER_HOME)"
    fi
    # Now convert the arguments
    for i do
        echo "arg: $i"
    done
fi

# Split up the JVM_OPTS into GRADLE_OPTS and JAVA_OPTS
if [ "$cygwin" = "false" -o "$msys" = "false" ] ; then
    JAVACMD="$JAVACMD $GRADLE_OPTS"
fi

# Escape application args
save () {
    for i do printf %s\\\\n "$i" | sed "s/'/'\\\\\\\\''/g;1s/^/'/;\$s/\$/' \\\\\\\\/" ; done
    echo " "
}
APP_ARGS=$(save "$@")

# Collect all arguments for the java command, following the shell quoting and substitution rules
eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"

# by default we should be in the "project" dir
cd "$APP_HOME"

exec "$JAVACMD" "$@"
EOF
        
        chmod +x gradlew
        
        # Create gradlew.bat for Windows
        cat > gradlew.bat << 'EOF'
@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem

@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto execute

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega
EOF
        
        echo "Gradle wrapper created"
    
    - name: Build APK (simulated - no Android SDK)
      run: |
        echo "=== Simulating APK build ==="
        
        # Since we don't have Android SDK installed, we'll simulate the build
        echo "Creating simulated APK file..."
        
        mkdir -p app/build/outputs/apk/debug/
        cat > app/build/outputs/apk/debug/app-debug.apk << EOF
=== SIMULATED APK FILE ===
Build ID: ${{ github.event.inputs.build_id }}
App Name: ${{ github.event.inputs.app_name }}
Package: ${{ github.event.inputs.package_name }}
Website: ${{ github.event.inputs.website_url }}
Build Time: $(date)
GitHub Run: $GITHUB_RUN_ID

Note: This is a simulated APK file.
In a real setup, this would be a proper Android APK built with Gradle.
EOF
        
        echo "Simulated APK created at: app/build/outputs/apk/debug/app-debug.apk"
        ls -la app/build/outputs/apk/debug/
    
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-app-${{ github.event.inputs.build_id }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7
    
    - name: Notify build completed
      run: |
        echo "=== Notifying completion ==="
        
        # Create download URL (in real scenario, upload to server)
        ARTIFACT_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        echo "Artifact available at: $ARTIFACT_URL"
        
        # Send notification to backend
        curl -X POST "https://savist.online/update_build_status.php" \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"${{ github.event.inputs.build_id }}\",\"status\":\"completed\",\"run_id\":\"$GITHUB_RUN_ID\",\"apk_url\":\"$ARTIFACT_URL\"}" \
          --silent || echo "Final notification failed"
    
    - name: Build Summary
      run: |
        echo "=========================================="
        echo "           BUILD SUMMARY"
        echo "=========================================="
        echo "Build ID:     ${{ github.event.inputs.build_id }}"
        echo "App Name:     ${{ github.event.inputs.app_name }}"
        echo "Package:      ${{ github.event.inputs.package_name }}"
        echo "Website:      ${{ github.event.inputs.website_url }}"
        echo "Logo URL:     ${{ github.event.inputs.logo_url }}"
        echo "GitHub Run:   https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "Status:       âœ… COMPLETED"
        echo ""
        echo "Note: APK generation is simulated."
        echo "For real APK builds, install Android SDK in workflow."
        echo "=========================================="
