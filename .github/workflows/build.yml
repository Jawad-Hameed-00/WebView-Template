name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID from database'
        required: true
        type: string
      website_url:
        description: 'Website URL for WebView'
        required: true
        type: string
      app_name:
        description: 'App name'
        required: true
        type: string
      package_name:
        description: 'Android package name'
        required: true
        type: string
      logo_url:
        description: 'Logo URL'
        required: false
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.build_id }}
  WEBSITE_URL: ${{ github.event.inputs.website_url }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  PACKAGE_NAME: ${{ github.event.inputs.package_name }}
  LOGO_URL: ${{ github.event.inputs.logo_url }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Log inputs
      run: |
        echo "=== Build Parameters ==="
        echo "Build ID: $BUILD_ID"
        echo "Website URL: $WEBSITE_URL"
        echo "App Name: $APP_NAME"
        echo "Package Name: $PACKAGE_NAME"
        echo "Logo URL: $LOGO_URL"
        echo "========================="
    
    - name: Notify build started
      run: |
        curl -X POST "https://savist.online/update_build_status.php" \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"processing\",\"run_id\":\"$GITHUB_RUN_ID\"}"
      continue-on-error: true
    
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
    
    - name: Setup Java JDK
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Download logo if provided
      if: env.LOGO_URL != ''
      run: |
        echo "Downloading logo from: $LOGO_URL"
        curl -L -o app/src/main/res/drawable/app_logo.png "$LOGO_URL"
    
    - name: Update app configuration
      run: |
        echo "=== Updating app configuration ==="
        
        # Update app name in strings.xml
        if [ -f "app/src/main/res/values/strings.xml" ]; then
          echo "Updating strings.xml..."
          sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">$APP_NAME</string>|g" app/src/main/res/values/strings.xml
          sed -i "s|<string name=\"website_url\">.*</string>|<string name=\"website_url\">$WEBSITE_URL</string>|g" app/src/main/res/values/strings.xml
        else
          echo "Creating strings.xml..."
          mkdir -p app/src/main/res/values
          cat > app/src/main/res/values/strings.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
          <string name="app_name">$APP_NAME</string>
          <string name="website_url">$WEBSITE_URL</string>
          </resources>
        EOF
        fi
        
        # Update package name in build.gradle
        if [ -f "app/build.gradle" ]; then
          echo "Updating build.gradle package name..."
          sed -i "s|applicationId \".*\"|applicationId \"$PACKAGE_NAME\"|g" app/build.gradle
        fi
        
        # Update package name in AndroidManifest.xml
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          echo "Updating AndroidManifest.xml package..."
          sed -i "s|package=\".*\"|package=\"$PACKAGE_NAME\"|g" app/src/main/AndroidManifest.xml
        fi
        
        echo "Configuration updated successfully"
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Build APK
      run: |
        echo "=== Building APK ==="
        chmod +x gradlew
        ./gradlew assembleDebug
        echo "APK built successfully"
    
    - name: Find APK file
      id: find-apk
      run: |
        APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "APK not found!"
          exit 1
        fi
        echo "APK found at: $APK_PATH"
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
    
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-app-${{ env.BUILD_ID }}
        path: ${{ steps.find-apk.outputs.apk_path }}
    
    - name: Create download URL
      id: create-url
      run: |
        # Create a mock download URL (in real scenario, upload to server)
        DOWNLOAD_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
        echo "GitHub Run URL: $DOWNLOAD_URL"
    
    - name: Notify build completed
      run: |
        DOWNLOAD_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "Notifying completion with download URL: $DOWNLOAD_URL"
        
        curl -X POST "https://savist.online/update_build_status.php" \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"completed\",\"run_id\":\"$GITHUB_RUN_ID\",\"apk_url\":\"$DOWNLOAD_URL\"}"
      continue-on-error: true
    
    - name: Build Summary
      if: always()
      run: |
        echo "=== Build Summary ==="
        echo "Build ID: $BUILD_ID"
        echo "App Name: $APP_NAME"
        echo "Package: $PACKAGE_NAME"
        echo "Website: $WEBSITE_URL"
        echo "GitHub Run: https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "====================="
