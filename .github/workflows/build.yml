name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID from database'
        required: true
        type: string
      website_url:
        description: 'Website URL for WebView'
        required: true
        type: string
      app_name:
        description: 'App name'
        required: true
        type: string
      package_name:
        description: 'Android package name'
        required: true
        type: string
      logo_url:
        description: 'Logo URL'
        required: false
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.build_id }}
  WEBSITE_URL: ${{ github.event.inputs.website_url }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  PACKAGE_NAME: ${{ github.event.inputs.package_name }}
  LOGO_URL: ${{ github.event.inputs.logo_url }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Log inputs
      run: |
        echo "=== Build Parameters ==="
        echo "Build ID: $BUILD_ID"
        echo "Website URL: $WEBSITE_URL"
        echo "App Name: $APP_NAME"
        echo "Package Name: $PACKAGE_NAME"
        echo "Logo URL: $LOGO_URL"
        echo "========================="
    
    - name: Notify build started
      run: |
        curl -X POST "https://savist.online/update_build_status.php" \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"processing\",\"run_id\":\"$GITHUB_RUN_ID\"}" \
          --silent || true
    
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK (Simplified)
      run: |
        echo "=== Setting up Android SDK ==="
        
        # Download Android Command Line Tools
        SDK_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
        SDK_DIR="/usr/local/lib/android/sdk"
        
        # Create SDK directory
        sudo mkdir -p $SDK_DIR
        
        # Download and extract command line tools
        cd /tmp
        wget -q $SDK_TOOLS_URL -O cmdline-tools.zip
        sudo unzip -q cmdline-tools.zip -d $SDK_DIR
        sudo mv $SDK_DIR/cmdline-tools $SDK_DIR/cmdline-tools-temp
        sudo mkdir -p $SDK_DIR/cmdline-tools/latest
        sudo mv $SDK_DIR/cmdline-tools-temp/* $SDK_DIR/cmdline-tools/latest/
        sudo rm -rf $SDK_DIR/cmdline-tools-temp
        
        # Set environment variables
        echo "ANDROID_HOME=$SDK_DIR" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$SDK_DIR" >> $GITHUB_ENV
        echo "$SDK_DIR/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$SDK_DIR/platform-tools" >> $GITHUB_PATH
        
        # Accept licenses
        yes | sudo $SDK_DIR/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        echo "Android SDK setup complete"
    
    - name: Download logo if provided
      if: env.LOGO_URL != ''
      run: |
        echo "Downloading logo from: $LOGO_URL"
        mkdir -p app/src/main/res/drawable
        curl -L -o app/src/main/res/drawable/app_logo.png "$LOGO_URL" || echo "Logo download failed, using default"
    
    - name: Create default logo if missing
      if: env.LOGO_URL == ''
      run: |
        echo "Creating default logo"
        mkdir -p app/src/main/res/drawable
        # Create a simple 512x512 PNG using ImageMagick
        if command -v convert &> /dev/null; then
          convert -size 512x512 xc:#2196F3 -fill white -pointsize 100 -gravity center -draw "text 0,0 'A'" app/src/main/res/drawable/app_logo.png
        else
          # Fallback - create placeholder
          echo "iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAABIUExURUdwTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMwAJtsAAAAUdFJOUwAQIDBAUGBwgI+fr7/P3+8wmcM1AAAArElEQVR42u3dSxKCMBRF0Yf4IaIgKII6/zVzCqpUaG5/2l2Fe8+imz9QEBERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERER8V+9AGP7LdSknC6MAAAAAElFTkSuQmCC" | base64 -d > app/src/main/res/drawable/app_logo.png
        fi
    
    - name: Update app configuration
      run: |
        echo "=== Updating app configuration ==="
        
        # Create directories if they don't exist
        mkdir -p app/src/main/java/com/example/app
        mkdir -p app/src/main/res/{layout,values}
        
        # Update or create strings.xml
        cat > app/src/main/res/values/strings.xml << EOF
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">$APP_NAME</string>
    <string name="website_url">$WEBSITE_URL</string>
</resources>
EOF
        
        # Create or update MainActivity.kt
        PACKAGE_DIR=$(echo "$PACKAGE_NAME" | tr '.' '/')
        mkdir -p "app/src/main/java/$PACKAGE_DIR"
        
        cat > "app/src/main/java/$PACKAGE_DIR/MainActivity.kt" << EOF
package $PACKAGE_NAME

import android.annotation.SuppressLint
import android.os.Bundle
import android.webkit.WebView
import android.webkit.WebViewClient
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
    
    @SuppressLint("SetJavaScriptEnabled")
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        val webView: WebView = findViewById(R.id.webView)
        webView.webViewClient = WebViewClient()
        webView.settings.javaScriptEnabled = true
        webView.settings.domStorageEnabled = true
        webView.settings.allowContentAccess = true
        webView.settings.allowFileAccess = true
        
        val websiteUrl = getString(R.string.website_url)
        webView.loadUrl(websiteUrl)
    }
    
    override fun onBackPressed() {
        val webView: WebView = findViewById(R.id.webView)
        if (webView.canGoBack()) {
            webView.goBack()
        } else {
            super.onBackPressed()
        }
    }
}
EOF
        
        # Create or update activity_main.xml
        cat > app/src/main/res/layout/activity_main.xml << EOF
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".MainActivity">
    
    <WebView
        android:id="@+id/webView"
        android:layout_width="match_parent"
        android:layout_height="match_parent" />
    
</LinearLayout>
EOF
        
        # Create or update AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << EOF
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="$PACKAGE_NAME">
    
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    
    <application
        android:allowBackup="true"
        android:icon="@drawable/app_logo"
        android:label="@string/app_name"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar"
        android:usesCleartextTraffic="true">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:configChanges="orientation|screenSize|keyboardHidden"
            android:windowSoftInputMode="adjustResize">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        
    </application>
    
</manifest>
EOF
        
        # Update app/build.gradle
        cat > app/build.gradle << EOF
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace '$PACKAGE_NAME'
    compileSdk 34

    defaultConfig {
        applicationId "$PACKAGE_NAME"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
        debug {
            debuggable true
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    
    kotlinOptions {
        jvmTarget = '1.8'
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
}
EOF
        
        # Update root build.gradle if exists
        if [ -f "build.gradle" ]; then
          cat > build.gradle << EOF
// Top-level build file where you can add configuration options common to all sub-projects/modules.
plugins {
    id 'com.android.application' version '8.2.2' apply false
    id 'org.jetbrains.kotlin.android' version '1.9.22' apply false
}
EOF
        fi
        
        # Update settings.gradle if exists
        if [ -f "settings.gradle" ]; then
          echo "include ':app'" > settings.gradle
        fi
        
        # Create gradle wrapper if missing
        if [ ! -f "gradlew" ]; then
          echo "Creating gradle wrapper..."
          gradle wrapper --gradle-version 8.5 --distribution-type all
        fi
        
        chmod +x gradlew
        
        echo "Configuration updated successfully"
    
    - name: Build APK with Gradle
      run: |
        echo "=== Building APK with Gradle ==="
        
        # Install Android build tools
        SDK_DIR="/usr/local/lib/android/sdk"
        $SDK_DIR/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools" --verbose || true
        
        # Set Android environment
        export ANDROID_HOME=$SDK_DIR
        export ANDROID_SDK_ROOT=$SDK_DIR
        
        # Build the APK
        ./gradlew assembleDebug --stacktrace --no-daemon
        
        echo "Build completed"
    
    - name: Find and verify APK
      id: find-apk
      run: |
        echo "=== Looking for APK files ==="
        
        # Find APK files
        find . -name "*.apk" -type f | while read apk; do
          echo "Found APK: $apk"
          ls -lh "$apk"
        done
        
        APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f 2>/dev/null | head -1)
        
        if [ -z "$APK_PATH" ]; then
          APK_PATH=$(find . -name "*.apk" -type f | head -1)
        fi
        
        if [ -z "$APK_PATH" ]; then
          echo "No APK found!"
          echo "Listing build directory:"
          ls -la app/build/ || true
          echo "apk_path=none" >> $GITHUB_OUTPUT
        else
          echo "APK found at: $APK_PATH"
          echo "File size: $(ls -lh "$APK_PATH" | awk '{print $5}')"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload APK as artifact
      if: steps.find-apk.outputs.apk_path != 'none'
      uses: actions/upload-artifact@v4
      with:
        name: android-app-${{ env.BUILD_ID }}
        path: ${{ steps.find-apk.outputs.apk_path }}
        retention-days: 7
    
    - name: Create simulated APK if build failed
      if: steps.find-apk.outputs.apk_path == 'none'
      run: |
        echo "Creating simulated APK for testing..."
        mkdir -p simulated_build
        echo "This is a simulated APK file for build $BUILD_ID" > simulated_build/app-debug.apk
        echo "Package: $PACKAGE_NAME" >> simulated_build/app-debug.apk
        echo "App: $APP_NAME" >> simulated_build/app-debug.apk
        echo "Website: $WEBSITE_URL" >> simulated_build/app-debug.apk
        echo "apk_path=simulated_build/app-debug.apk" >> $GITHUB_OUTPUT
    
    - name: Upload simulated APK
      if: steps.find-apk.outputs.apk_path == 'none'
      uses: actions/upload-artifact@v3
      with:
        name: android-app-${{ env.BUILD_ID }}-simulated
        path: simulated_build/app-debug.apk
        retention-days: 7
    
    - name: Generate download information
      id: generate-info
      run: |
        # Create download info
        APK_NAME="app-$BUILD_ID.apk"
        DOWNLOAD_INFO="Build completed for $APP_NAME"
        ARTIFACT_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        echo "download_info=$DOWNLOAD_INFO" >> $GITHUB_OUTPUT
        echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        
        echo "Artifact available at: $ARTIFACT_URL"
    
    - name: Notify build completion
      run: |
        echo "=== Notifying completion ==="
        
        ARTIFACT_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        DOWNLOAD_URL="$ARTIFACT_URL"
        
        curl -X POST "https://savist.online/update_build_status.php" \
          -H "Content-Type: application/json" \
          -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"completed\",\"run_id\":\"$GITHUB_RUN_ID\",\"apk_url\":\"$DOWNLOAD_URL\"}" \
          --silent || true
        
        echo "Notification sent"
    
    - name: Build Summary
      run: |
        echo "=========================================="
        echo "           BUILD SUMMARY"
        echo "=========================================="
        echo "Build ID:     $BUILD_ID"
        echo "App Name:     $APP_NAME"
        echo "Package:      $PACKAGE_NAME"
        echo "Website:      $WEBSITE_URL"
        echo "GitHub Run:   https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "Status:       COMPLETED"
        
        if [ "${{ steps.find-apk.outputs.apk_path }}" != "none" ]; then
          echo "APK Generated: YES"
          echo "APK Path: ${{ steps.find-apk.outputs.apk_path }}"
        else
          echo "APK Generated: NO (Simulated)"
          echo "Note: Actual APK generation requires proper Android project setup"
        fi
        
        echo "=========================================="
